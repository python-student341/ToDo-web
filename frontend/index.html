<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ToDo ‚Äî FastAPI Client</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-3xl font-bold text-center mb-6">ToDo ‚Äî FastAPI</h1>

    <!-- Auth buttons -->
    <div class="flex justify-between mb-6">
      <button id="loginBtn" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">–í–æ–π—Ç–∏</button>
      <button id="registerBtn" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      <button id="logoutBtn" class="hidden bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded">–í—ã–π—Ç–∏</button>
    </div>

    <!-- Add task -->
    <div id="addTaskContainer" class="hidden mb-6">
      <div class="flex space-x-2">
        <input id="taskInput" type="text" placeholder="–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞..." class="flex-1 border p-2 rounded"/>
        <button id="addTaskBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <!-- Task list -->
    <div id="taskList" class="space-y-4"></div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded hidden"></div>

  <!-- Modals -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg w-96">
      <h2 id="modalTitle" class="text-xl font-bold mb-4"></h2>
      <div id="modalContent" class="space-y-3"></div>
      <div class="flex justify-end space-x-2 mt-4">
        <button id="modalCancel" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded">–û—Ç–º–µ–Ω–∞</button>
        <button id="modalConfirm" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">OK</button>
      </div>
    </div>
  </div>

  <script>
    const apiBase = '';
    let token = null;

    const taskList = document.getElementById('taskList');
    const addTaskContainer = document.getElementById('addTaskContainer');
    const logoutBtn = document.getElementById('logoutBtn');
    const toast = document.getElementById('toast');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    const modalConfirm = document.getElementById('modalConfirm');
    const modalCancel = document.getElementById('modalCancel');

    function showToast(msg, duration = 2000) {
      toast.textContent = msg;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), duration);
    }

    function openModal(title, contentHTML, onConfirm) {
      modalTitle.textContent = title;
      modalContent.innerHTML = contentHTML;
      modal.classList.remove('hidden');
      modalConfirm.onclick = () => { onConfirm(); closeModal(); };
      modalCancel.onclick = closeModal;
    }

    function closeModal() {
      modal.classList.add('hidden');
    }

    async function fetchTasks() {
      const res = await fetch(`${apiBase}/get_tasks`, { credentials: 'include' });
      const tasks = await res.json();
      const subRes = await fetch(`${apiBase}/get_subtasks`, { credentials: 'include' });
      let subs = await subRes.json();

      // –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ {subtasks: [...]}
      if (subs.subtasks) subs = subs.subtasks;

      renderTasks(tasks, subs);
    }

    function renderTasks(tasks, subs) {
      taskList.innerHTML = '';

      if (!tasks.length) {
        taskList.innerHTML = '<p class="text-center text-gray-500">–ó–∞–¥–∞—á –Ω–µ—Ç.</p>';
        return;
      }

      tasks.forEach(task => {
        const card = document.createElement('div');
        card.className = 'bg-white shadow rounded p-4';

        const subsForTask = subs.filter(s => s.task_id === task.id);

        card.innerHTML = `
          <div class="flex justify-between items-center mb-2">
            <h3 class="text-lg font-semibold">${task.title}</h3>
            <div class="space-x-2">
              <button class="editTask bg-yellow-400 hover:bg-yellow-500 text-white px-2 py-1 rounded" data-id="${task.id}">‚úèÔ∏è</button>
              <button class="deleteTask bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded" data-id="${task.id}">üóëÔ∏è</button>
              <button class="addSub bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded" data-id="${task.id}">‚ûï –ü–æ–¥–∑–∞–¥–∞—á–∞</button>
            </div>
          </div>
          ${subsForTask.length ? `
            <ul class="ml-4 border-l pl-3 space-y-1">
              ${subsForTask.map(s => `
                <li class="flex justify-between items-center">
                  <span>${s.title}</span>
                  <div class="space-x-2">
                    <button class="editSub bg-yellow-400 hover:bg-yellow-500 text-white px-2 py-1 rounded" data-id="${s.id}">‚úèÔ∏è</button>
                    <button class="deleteSub bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded" data-id="${s.id}">üóëÔ∏è</button>
                  </div>
                </li>`).join('')}
            </ul>` : '<p class="text-gray-500 ml-4">–ù–µ—Ç –ø–æ–¥–∑–∞–¥–∞—á</p>'}
        `;

        taskList.appendChild(card);
      });

      document.querySelectorAll('.deleteTask').forEach(b => b.onclick = deleteTask);
      document.querySelectorAll('.editTask').forEach(b => b.onclick = editTask);
      document.querySelectorAll('.addSub').forEach(b => b.onclick = addSubtask);
      document.querySelectorAll('.deleteSub').forEach(b => b.onclick = deleteSubtask);
      document.querySelectorAll('.editSub').forEach(b => b.onclick = editSubtask);
    }

    async function deleteTask(e) {
      const id = e.target.dataset.id;
      await fetch(`${apiBase}/delete_task/${id}`, { method: 'DELETE', credentials: 'include' });
      showToast('–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞');
      fetchTasks();
    }

    function editTask(e) {
      const id = e.target.dataset.id;
      openModal('–ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞—á—É', `<input id="editTaskInput" class="w-full border p-2 rounded" placeholder="–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">`, async () => {
        const title = document.getElementById('editTaskInput').value;
        await fetch(`${apiBase}/change_task/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ title })
        });
        showToast('–ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
        fetchTasks();
      });
    }

    function addSubtask(e) {
      const taskId = e.target.dataset.id;
      openModal('–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É', `<input id="subInput" class="w-full border p-2 rounded" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–∑–∞–¥–∞—á–∏">`, async () => {
        const title = document.getElementById('subInput').value;
        await fetch(`${apiBase}/add_task/add_subtask/${taskId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ title })
        });
        showToast('–ü–æ–¥–∑–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
        fetchTasks();
      });
    }

    async function deleteSubtask(e) {
      const id = e.target.dataset.id;
      await fetch(`${apiBase}/delete_subtask/${id}`, { method: 'DELETE', credentials: 'include' });
      showToast('–ü–æ–¥–∑–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞');
      fetchTasks();
    }

    function editSubtask(e) {
      const id = e.target.dataset.id;
      openModal('–ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É', `<input id="editSubInput" class="w-full border p-2 rounded" placeholder="–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">`, async () => {
        const title = document.getElementById('editSubInput').value;
        await fetch(`${apiBase}/change_subtask/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ title })
        });
        showToast('–ü–æ–¥–∑–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
        fetchTasks();
      });
    }

    document.getElementById('addTaskBtn').onclick = async () => {
      const title = document.getElementById('taskInput').value;
      await fetch(`${apiBase}/add_task`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ title })
      });
      document.getElementById('taskInput').value = '';
      showToast('–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
      fetchTasks();
    };

    document.getElementById('loginBtn').onclick = () => {
      openModal('–í–æ–π—Ç–∏', `
        <input id="email" class="w-full border p-2 rounded" placeholder="Email">
        <input id="password" type="password" class="w-full border p-2 rounded" placeholder="–ü–∞—Ä–æ–ª—å">
      `, async () => {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const res = await fetch(`${apiBase}/users/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
          credentials: 'include'
        });
        if (res.ok) {
          showToast('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥');
          addTaskContainer.classList.remove('hidden');
          logoutBtn.classList.remove('hidden');
          fetchTasks();
        } else showToast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
      });
    };

    document.getElementById('registerBtn').onclick = () => {
      openModal('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è', `
        <input id="email" class="w-full border p-2 rounded" placeholder="Email">
        <input id="password" type="password" class="w-full border p-2 rounded" placeholder="–ü–∞—Ä–æ–ª—å">
      `, async () => {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const res = await fetch(`${apiBase}/users/add_new_user`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password }),
          credentials: 'include'
        });
        if (res.ok) showToast('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
        else showToast('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
      });
    };

    logoutBtn.onclick = () => {
      addTaskContainer.classList.add('hidden');
      logoutBtn.classList.add('hidden');
      taskList.innerHTML = '';
      showToast('–í—ã –≤—ã—à–ª–∏');
    };
  </script>
</body>
</html>
