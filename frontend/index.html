<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ToDo — Front for your FastAPI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#0f1724; color:#e6eef8; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .card { background:#0b1220; border-radius:14px; box-shadow: 0 8px 30px rgba(3,7,18,0.7); }
    .input { background:#131c2e; color:inherit; border-radius:10px; padding:10px 12px; outline:none; border:1px solid rgba(255,255,255,0.03) }
    .btn { background:#6366f1; color:white; padding:8px 12px; border-radius:10px; font-weight:600; cursor:pointer; }
    .btn-red { background:#ef4444; }
    .muted { color:#93a0b0 }
    .small { font-size:13px }
    .task { background:#0f1a2b; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.02); display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap: wrap; }
    .icon-btn { display:flex; gap:10px; align-items:center; }
    .delete-btn, .edit-btn, .save-btn, .add-subtask-btn { cursor:pointer; transition:all 0.2s ease; }
    .delete-btn { color:#ef4444; }
    .edit-btn { color:#3b82f6; }
    .save-btn { color:#10b981; }
    .add-subtask-btn { color:#f59e0b; }
    .delete-btn:hover { color:#f87171; transform:scale(1.15); }
    .edit-btn:hover { color:#60a5fa; transform:scale(1.15); }
    .save-btn:hover { color:#34d399; transform:scale(1.15); }
    .add-subtask-btn:hover { color:#fbbf24; transform:scale(1.15); }
    .subtask { margin-left: 2rem; background:#111a2d; padding:8px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; }
    .modal-bg {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;}
    .modal {background:#0b1220;padding:20px;border-radius:12px;width:320px;}
    /* Кнопка добавления для мобильных */
    @media (max-width: 768px) {
      #mobileAddWrapper { display: flex; gap: 5px; margin-top: 10px; }
    }
    @media (min-width: 769px) {
      #mobileAddWrapper { display: none; }
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6">

  <div id="root" class="w-full max-w-3xl">

    <!-- AUTH CARD -->
    <div id="auth" class="card p-8 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold">Вход / Регистрация</h2>
        <div class="muted small">API: <span id="apiUrlDisplay"></span></div>
      </div>

      <div id="mode-login">
        <input id="email" class="input w-full mb-3" placeholder="Email" type="email"/>
        <input id="password" class="input w-full mb-3" placeholder="Пароль" type="password"/>
        <div class="flex gap-3">
          <button id="loginBtn" class="btn">Войти</button>
          <button id="gotoRegister" class="btn" style="background:#10b981">Зарегистрироваться</button>
        </div>
      </div>

      <div id="mode-register" style="display:none">
        <input id="reg_name" class="input w-full mb-3" placeholder="Имя"/>
        <input id="reg_age" class="input w-full mb-3" placeholder="Возраст" type="number"/>
        <input id="reg_email" class="input w-full mb-3" placeholder="Email" type="email"/>
        <input id="reg_password" class="input w-full mb-3" placeholder="Пароль" type="password"/>
        <input id="reg_repeat_password" class="input w-full mb-3" placeholder="Повторите пароль" type="password"/>
        <div class="flex gap-3">
          <button id="registerBtn" class="btn">Зарегистрировать</button>
          <button id="gotoLogin" class="btn" style="background:#64748b">Назад</button>
        </div>
      </div>

      <div class="mt-4 small muted">
        <div>Важно: открой этот файл через сервер, фронт и бэкенд должны быть на одном домене.</div>
      </div>
    </div>

    <!-- CABINET -->
    <div id="cabinet" class="card p-6" style="display:none;">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-xl font-bold">Личный кабинет</h3>
          <div id="userEmail" class="muted small">—</div>
        </div>
        <div class="flex items-center gap-2">
          <button id="refreshTasks" class="btn small">Обновить</button>
          <button id="logoutBtn" class="btn btn-red small">Выйти</button>
        </div>
      </div>

      <div class="flex gap-2 mb-4">
        <button id="changeNameBtn" class="btn small">Изменить имя</button>
        <button id="changePassBtn" class="btn small" style="background:#8b5cf6">Изменить пароль</button>
        <button id="deleteUserBtn" class="btn btn-red small">Удалить пользователя</button>
      </div>

      <div class="mb-4 flex gap-3" id="desktopAddWrapper">
        <input id="taskText" class="input flex-1" placeholder="Текст задачи"/>
        <input id="taskDate" class="input w-48" type="datetime-local"/>
        <button id="addTaskBtn" class="btn">Добавить</button>
      </div>

      <div id="tasksList" class="space-y-3 max-h-96 overflow-auto mb-4"></div>
      <div class="small muted mb-2">Теперь можно редактировать задачи ✏️, удалять ❌ и добавлять подзадачи ➕</div>

      <!-- Добавление для мобильных -->
      <div id="mobileAddWrapper">
        <input id="taskTextMobile" class="input flex-1" placeholder="Текст задачи"/>
        <input id="taskDateMobile" class="input w-36" type="datetime-local"/>
        <button id="addTaskBtnMobile" class="btn">Добавить</button>
      </div>
    </div>

  </div>

  <!-- MODALS -->
  <div id="modalBg" class="modal-bg">
    <div id="modalContent" class="modal"></div>
  </div>

<script>
const API_URL = location.origin;
document.getElementById('apiUrlDisplay').textContent = API_URL;

function setCookieToken(token){const days=7;const expires=new Date(Date.now()+days*86400000).toUTCString();document.cookie=`token=${token}; path=/; expires=${expires}`;}
function getCookie(name){const v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');return v?v.pop():'';}
function decodeJwt(token){try{return JSON.parse(atob(token.split('.')[1]));}catch(e){return {};}}
function openModal(html){const bg=document.getElementById('modalBg');const c=document.getElementById('modalContent');c.innerHTML=html;bg.style.display='flex';}
function closeModal(){document.getElementById('modalBg').style.display='none';}
document.getElementById('modalBg').onclick=(e)=>{if(e.target.id==='modalBg')closeModal();};

let currentUserId=null;

const auth=document.getElementById('auth');
const cabinet=document.getElementById('cabinet');
document.getElementById('gotoRegister').onclick=()=>{auth.querySelector('#mode-login').style.display='none';auth.querySelector('#mode-register').style.display='block';};
document.getElementById('gotoLogin').onclick=()=>{auth.querySelector('#mode-register').style.display='none';auth.querySelector('#mode-login').style.display='block';};

document.getElementById('loginBtn').onclick=async()=>{
  const email=emailInput.value.trim(),password=passwordInput.value.trim();
  if(!email||!password)return alert('Введите email и пароль');
  const res=await fetch(`${API_URL}/users/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
  const data=await res.json();
  if(data.success){
    if(data.token)setCookieToken(data.token);
    const decoded=decodeJwt(data.token);
    currentUserId=parseInt(decoded.sub);
    openCabinet(email);
    loadTasks();
  } else alert(data.msg||'Ошибка входа');
};
const emailInput=document.getElementById('email');
const passwordInput=document.getElementById('password');

document.getElementById('registerBtn').onclick=async()=>{
  const name=reg_name.value.trim(),age=parseInt(reg_age.value),email=reg_email.value.trim(),password=reg_password.value.trim(),repeat_password=reg_repeat_password.value.trim();
  if(!name||!age||!email||!password||!repeat_password)return alert('Заполни все поля');
  const res=await fetch(`${API_URL}/users/add_new_user`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,age,email,password,repeat_password})});
  const data=await res.json();
  if(data.success){alert('Успешная регистрация');document.getElementById('gotoLogin').click();}
  else alert(data.detail||data.msg||'Ошибка регистрации');
};

function openCabinet(email){
  auth.style.display='none';
  cabinet.style.display='block';
  document.getElementById('userEmail').textContent=email;
  // Копируем значения для мобильной формы
  taskTextMobile.value = '';
  taskDateMobile.value = '';
}

document.getElementById('logoutBtn').onclick=()=>{document.cookie='token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';cabinet.style.display='none';auth.style.display='block';};

// === МОДАЛЫ для изменения и удаления ===
document.getElementById('changeNameBtn').onclick=()=>{
  openModal(`
    <h3 class="text-lg font-bold mb-3">Изменить имя</h3>
    <input id="newName" class="input w-full mb-2" placeholder="Новое имя"/>
    <input id="passForName" class="input w-full mb-4" type="password" placeholder="Пароль"/>
    <div class="flex gap-2 justify-end">
      <button onclick="closeModal()" class="btn small" style="background:#64748b">Отмена</button>
      <button onclick="saveNewName()" class="btn small">Сохранить</button>
    </div>`);
};

async function saveNewName(){
  const name=document.getElementById('newName').value.trim();
  const password=document.getElementById('passForName').value.trim();
  if(!name||!password)return alert('Заполните все поля');
  const res=await fetch(`${API_URL}/users/change_name/${currentUserId}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,password})});
  const data=await res.json();
  alert(data.message||data.msg||'Ошибка');
  if(data.success)closeModal();
}

document.getElementById('changePassBtn').onclick=()=>{
  openModal(`
    <h3 class="text-lg font-bold mb-3">Изменить пароль</h3>
    <input id="oldPass" class="input w-full mb-2" type="password" placeholder="Старый пароль"/>
    <input id="newPass" class="input w-full mb-2" type="password" placeholder="Новый пароль"/>
    <input id="repeatPass" class="input w-full mb-4" type="password" placeholder="Повторите новый пароль"/>
    <div class="flex gap-2 justify-end">
      <button onclick="closeModal()" class="btn small" style="background:#64748b">Отмена</button>
      <button onclick="saveNewPassword()" class="btn small">Сохранить</button>
    </div>`);
};

async function saveNewPassword(){
  const old=document.getElementById('oldPass').value.trim();
  const n1=document.getElementById('newPass').value.trim();
  const n2=document.getElementById('repeatPass').value.trim();
  if(!old||!n1||!n2)return alert('Заполните все поля');
  const res=await fetch(`${API_URL}/users/change_password/${currentUserId}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({old_password:old,new_password:n1,repeat_new_password:n2})});
  const data=await res.json();
  alert(data.message||data.msg||'Ошибка');
  if(data.success)closeModal();
}

document.getElementById('deleteUserBtn').onclick=()=>{
  openModal(`
    <h3 class="text-lg font-bold mb-3 text-red-400">Удалить пользователя</h3>
    <p class="small muted mb-2">Введите пароль для подтверждения:</p>
    <input id="deletePass" class="input w-full mb-4" type="password" placeholder="Пароль"/>
    <div class="flex gap-2 justify-end">
      <button onclick="closeModal()" class="btn small" style="background:#64748b">Отмена</button>
      <button onclick="confirmDeleteUser()" class="btn btn-red small">Удалить</button>
    </div>`);
};

async function confirmDeleteUser(){
  const password=document.getElementById('deletePass').value.trim();
  if(!password)return alert('Введите пароль');
  const res=await fetch(`${API_URL}/users/delete_user/${currentUserId}`,{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({password})});
  const data=await res.json();
  alert(data.message||data.msg||'Ошибка');
  if(data.success){closeModal();document.getElementById('logoutBtn').click();}
}

// ====== код задач с поддержкой мобильной кнопки ======
const taskText=document.getElementById('taskText'),
      taskDate=document.getElementById('taskDate'),
      taskTextMobile=document.getElementById('taskTextMobile'),
      taskDateMobile=document.getElementById('taskDateMobile');

document.getElementById('addTaskBtn').onclick=addTaskHandler;
document.getElementById('addTaskBtnMobile').onclick=addTaskHandler;

async function addTaskHandler(){
  let text, date;
  if(window.innerWidth <= 768){
    text = taskTextMobile.value.trim();
    date = taskDateMobile.value || new Date().toISOString();
  } else {
    text = taskText.value.trim();
    date = taskDate.value || new Date().toISOString();
  }
  if(!text)return alert('Введите текст задачи');
  const res=await fetch(`${API_URL}/add_task`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({task:text,date})});
  const data=await res.json();
  if(data.success){
    taskText.value=''; taskDate.value='';
    taskTextMobile.value=''; taskDateMobile.value='';
    loadTasks();
  } else alert(data.msg||'Ошибка добавления');
}

// ===== Остальной код задач без изменений ======
async function deleteTask(id){const res=await fetch(`${API_URL}/delete_task/${id}`,{method:'DELETE'});const data=await res.json();if(data.success)loadTasks();else alert(data.message||'Ошибка удаления');}
async function saveTask(taskId,inputText,inputDate){const newText=inputText.value.trim();const dateISO=new Date(inputDate.value).toISOString();const res=await fetch(`${API_URL}/change_task/${taskId}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({task:newText,date:dateISO})});const data=await res.json();if(data.success)loadTasks();else alert(data.message||'Ошибка обновления');}
function editTaskInline(task,container){container.innerHTML=`<div class="flex flex-col flex-1 gap-1"><input class="input w-full" value="${escapeHtml(task.task)}"/><input class="input w-48" type="datetime-local" value="${new Date(task.date).toISOString().slice(0,16)}"/></div><div class="icon-btn"><div class="save-btn" title="Сохранить"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg></div></div>`;const [inputText,inputDate]=container.querySelectorAll('input');container.querySelector('.save-btn').onclick=()=>saveTask(task.id,inputText,inputDate);}

async function addSubtask(todoId){
  const text=prompt('Текст подзадачи:');
  if(!text)return;
  const res=await fetch(`${API_URL}/add_subtask/${todoId}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({task:text})});
  const data=await res.json();
  if(data.success)loadTasks();else alert(data.msg||'Ошибка добавления подзадачи');
}

function escapeHtml(text){return text.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[c]));}

async function loadTasks(){
  const res=await fetch(`${API_URL}/tasks`);
  const data=await res.json();
  const list=document.getElementById('tasksList');
  list.innerHTML='';
  if(!Array.isArray(data))return;
  data.forEach(task=>{
    const el=document.createElement('div');
    el.className='task';
    el.innerHTML=`<div class="flex flex-col flex-1 gap-1"><div>${escapeHtml(task.task)}</div><div class="small muted">${new Date(task.date).toLocaleString()}</div></div>
    <div class="icon-btn">
      <div class="edit-btn" title="Редактировать">✏️</div>
      <div class="delete-btn" title="Удалить">❌</div>
      <div class="add-subtask-btn" title="Добавить подзадачу">➕</div>
    </div>`;
    const [editBtn,deleteBtn,addSubBtn]=el.querySelectorAll('.edit-btn,.delete-btn,.add-subtask-btn');
    editBtn.onclick=()=>editTaskInline(task,el);
    deleteBtn.onclick=()=>deleteTask(task.id);
    addSubBtn.onclick=()=>addSubtask(task.id);
    // Подзадачи
    if(task.subtasks && task.subtasks.length>0){
      task.subtasks.forEach(st=>{
        const subEl=document.createElement('div');
        subEl.className='subtask';
        subEl.innerHTML=`<div>${escapeHtml(st.task)}</div>`;
        el.appendChild(subEl);
      });
    }
    list.appendChild(el);
  });
}

</script>
</body>
</html>
